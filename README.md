# Weather Service - Servi√ßo de Clima por CEP

Sistema em Go que recebe um CEP brasileiro, identifica a cidade e retorna o clima atual em Celsius, Fahrenheit e Kelvin.

## üìã √çndice

- URL GCP: https://weather-service-activity-go-926876726731.us-central1.run.app/

- [Funcionalidades](#-funcionalidades)
- [Requisitos](#-requisitos)
- [Instala√ß√£o e Configura√ß√£o](#-instala√ß√£o-e-configura√ß√£o)
- [Uso Local](#-uso-local)
- [Endpoints da API](#-endpoints-da-api)
- [Testes](#-testes)
- [Deploy no Google Cloud Run](#-deploy-no-google-cloud-run)
- [Exemplos de Uso](#-exemplos-de-uso)
- [Troubleshooting](#-troubleshooting)

## üöÄ Funcionalidades

- ‚úÖ Valida√ß√£o de CEP (8 d√≠gitos)
- ‚úÖ Consulta de localiza√ß√£o via API ViaCEP
- ‚úÖ Consulta de temperatura via WeatherAPI
- ‚úÖ Convers√£o autom√°tica para Fahrenheit e Kelvin
- ‚úÖ Tratamento de erros apropriado (422, 404, 500)
- ‚úÖ Health check endpoint
- ‚úÖ Suporte a Docker e Docker Compose
- ‚úÖ Pronto para deploy no Google Cloud Run

## üì¶ Requisitos

- Docker e Docker Compose (para execu√ß√£o containerizada)
- Go 1.21+ (para desenvolvimento local)
- Conta WeatherAPI (gratuita) - [Criar conta](https://www.weatherapi.com/signup.aspx)
- Google Cloud SDK (apenas para deploy)

## üîß Instala√ß√£o e Configura√ß√£o

### 1. Estrutura do Projeto

```
weather-service/
‚îú‚îÄ‚îÄ main.go              # C√≥digo principal
‚îú‚îÄ‚îÄ main_test.go         # Testes automatizados
‚îú‚îÄ‚îÄ go.mod               # Depend√™ncias Go
‚îú‚îÄ‚îÄ go.sum               # Checksums
‚îú‚îÄ‚îÄ Dockerfile           # Configura√ß√£o Docker
‚îú‚îÄ‚îÄ docker-compose.yml   # Orquestra√ß√£o
‚îú‚îÄ‚îÄ .env                 # Vari√°veis de ambiente
‚îú‚îÄ‚îÄ .gitignore          # Arquivos ignorados
‚îî‚îÄ‚îÄ README.md           # Documenta√ß√£o
```

### 2. Obter API Key do WeatherAPI

1. Acesse [https://www.weatherapi.com/](https://www.weatherapi.com/)
2. Crie uma conta gratuita
3. Copie sua API key do dashboard

### 3. Configurar Vari√°veis de Ambiente

Crie um arquivo `.env` na raiz do projeto:

```bash
WEATHER_API_KEY=sua_chave_aqui
PORT=8080
```

## üê≥ Uso Local com Docker

### Iniciar o Servi√ßo

```bash
# Build e iniciar
docker-compose up -d

# Ver logs
docker-compose logs -f

# Parar o servi√ßo
docker-compose down
```

### Testar o Servi√ßo

```bash
# CEP v√°lido (Av. Paulista, S√£o Paulo)
curl http://localhost:8080/weather/01310100

# Resposta esperada:
# {"temp_C":25.0,"temp_F":77.0,"temp_K":298.0}

# CEP inv√°lido (formato incorreto)
curl http://localhost:8080/weather/123
# {"message":"invalid zipcode"}

# CEP n√£o encontrado
curl http://localhost:8080/weather/99999999
# {"message":"can not find zipcode"}

# Health check
curl http://localhost:8080/health
# OK
```

## üèÉ Uso Local sem Docker

```bash
# Baixar depend√™ncias
go mod download

# Configurar vari√°vel de ambiente
export WEATHER_API_KEY=sua_chave_aqui

# Executar
go run main.go

# Em outro terminal, testar
curl http://localhost:8080/weather/01310100
```

## üì° Endpoints da API

### GET /weather/{cep}

Retorna a temperatura atual para o CEP informado.

**Par√¢metros:**
- `cep`: CEP brasileiro de 8 d√≠gitos (com ou sem h√≠fen)

**Respostas:**

#### ‚úÖ 200 OK - Sucesso
```json
{
  "temp_C": 28.5,
  "temp_F": 83.3,
  "temp_K": 301.5
}
```

#### ‚ùå 422 Unprocessable Entity - CEP Inv√°lido
```json
{
  "message": "invalid zipcode"
}
```

**Quando ocorre:**
- CEP com menos ou mais de 8 d√≠gitos
- CEP contendo letras ou caracteres especiais

#### ‚ùå 404 Not Found - CEP N√£o Encontrado
```json
{
  "message": "can not find zipcode"
}
```

**Quando ocorre:**
- CEP n√£o existe na base da ViaCEP

### GET /health

Health check endpoint para monitoramento.

**Resposta:**
```
HTTP/1.1 200 OK
OK
```

## üß™ Testes

### Executar Testes Unit√°rios

```bash
# Todos os testes
go test -v

# Com cobertura
go test -v -cover

# Relat√≥rio de cobertura HTML
go test -coverprofile=coverage.out
go tool cover -html=coverage.out
```

### Script de Teste Automatizado

Crie o arquivo `test.sh`:

```bash
#!/bin/bash

BASE_URL="${1:-http://localhost:8080}"

echo "Testing valid CEP..."
curl -s $BASE_URL/weather/01310100 | jq

echo -e "\nTesting invalid CEP format..."
curl -s $BASE_URL/weather/123 | jq

echo -e "\nTesting CEP not found..."
curl -s $BASE_URL/weather/99999999 | jq

echo -e "\nTesting health check..."
curl -s $BASE_URL/health
```

Executar:
```bash
chmod +x test.sh
./test.sh
```

## ‚òÅÔ∏è Deploy no Google Cloud Run

### Pr√©-requisitos

1. **Instalar Google Cloud SDK**
   ```bash
   # Linux/macOS
   curl https://sdk.cloud.google.com | bash
   exec -l $SHELL
   gcloud init
   ```

2. **Configurar Projeto**
   ```bash
   gcloud auth login
   gcloud config set project SEU_PROJECT_ID
   ```

3. **Habilitar APIs**
   ```bash
   gcloud services enable run.googleapis.com
   gcloud services enable cloudbuild.googleapis.com
   gcloud services enable containerregistry.googleapis.com
   ```

### Deploy em 2 Comandos

```bash
# 1. Build da imagem
gcloud builds submit --tag gcr.io/SEU_PROJECT_ID/weather-service

# 2. Deploy no Cloud Run
gcloud run deploy weather-service \
  --image gcr.io/SEU_PROJECT_ID/weather-service \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars WEATHER_API_KEY=SUA_CHAVE_AQUI \
  --memory 256Mi \
  --cpu 1 \
  --min-instances 0 \
  --max-instances 10
```

### Obter URL do Servi√ßo

```bash
gcloud run services describe weather-service \
  --region us-central1 \
  --format 'value(status.url)'
```

### Testar Servi√ßo no Cloud Run

```bash
# Substitua pela URL retornada
curl https://weather-service-xxxxx-xx.a.run.app/weather/01310100
```

### Atualizar o Servi√ßo

```bash
# Rebuild e redeploy
gcloud builds submit --tag gcr.io/SEU_PROJECT_ID/weather-service
gcloud run deploy weather-service \
  --image gcr.io/SEU_PROJECT_ID/weather-service \
  --region us-central1
```

### Gerenciar com Secrets Manager (Recomendado)

```bash
# Criar secret
echo -n "SUA_WEATHER_API_KEY" | \
  gcloud secrets create weather-api-key \
  --data-file=- \
  --replication-policy="automatic"

# Deploy usando secret
gcloud run deploy weather-service \
  --image gcr.io/SEU_PROJECT_ID/weather-service \
  --update-secrets=WEATHER_API_KEY=weather-api-key:latest \
  --region us-central1
```

### Monitoramento

```bash
# Ver logs em tempo real
gcloud run services logs tail weather-service --region us-central1

# Ver m√©tricas no console
# https://console.cloud.google.com/run
```

### Deletar o Servi√ßo

```bash
gcloud run services delete weather-service --region us-central1
```

## üìù Exemplos de Uso

### CEPs para Teste

| CEP | Localiza√ß√£o |
|-----|-------------|
| `01310100` | Av. Paulista, S√£o Paulo/SP |
| `20040020` | Centro, Rio de Janeiro/RJ |
| `30130100` | Centro, Belo Horizonte/MG |
| `70040902` | Bras√≠lia/DF |
| `88015100` | Centro, Florian√≥polis/SC |

### cURL

```bash
# B√°sico
curl http://localhost:8080/weather/01310100

# Com formata√ß√£o JSON (requer jq)
curl -s http://localhost:8080/weather/01310100 | jq

# Ver headers completos
curl -v http://localhost:8080/weather/01310100
```

### JavaScript (Fetch API)

```javascript
async function getWeather(cep) {
  try {
    const response = await fetch(`http://localhost:8080/weather/${cep}`);
    const data = await response.json();
    
    if (response.ok) {
      console.log(`Temperatura: ${data.temp_C}¬∞C`);
    } else {
      console.error(`Erro: ${data.message}`);
    }
  } catch (error) {
    console.error('Erro de conex√£o:', error);
  }
}

getWeather('01310100');
```

### Python (requests)

```python
import requests

def get_weather(cep):
    try:
        response = requests.get(f'http://localhost:8080/weather/{cep}')
        response.raise_for_status()
        data = response.json()
        print(f"Temperatura: {data['temp_C']}¬∞C")
        return data
    except requests.exceptions.HTTPError as e:
        print(f"Erro HTTP: {e}")
        print(f"Mensagem: {response.json()['message']}")
    except requests.exceptions.RequestException as e:
        print(f"Erro de conex√£o: {e}")

weather = get_weather('01310100')
```

## üßÆ F√≥rmulas de Convers√£o

O sistema utiliza as seguintes f√≥rmulas para convers√£o de temperatura:

- **Celsius para Fahrenheit**: `F = C √ó 1.8 + 32`
- **Celsius para Kelvin**: `K = C + 273`

## üõ†Ô∏è Desenvolvimento

### Comandos √öteis (Makefile)

Crie um `Makefile` com os comandos:

```makefile
.PHONY: run test docker-build docker-run docker-stop

run:
	go run main.go

test:
	go test -v -cover

docker-build:
	docker-compose build

docker-run:
	docker-compose up -d

docker-stop:
	docker-compose down

test-api:
	./test.sh
```

Uso:
```bash
make run          # Executar localmente
make test         # Rodar testes
make docker-run   # Iniciar com Docker
make test-api     # Testar API
```

### Estrutura do C√≥digo

**main.go** - Fun√ß√µes principais:
- `handleWeather()` - Handler principal do endpoint /weather
- `isValidCEPFormat()` - Valida formato do CEP
- `getLocationByCEP()` - Consulta ViaCEP
- `getTemperature()` - Consulta WeatherAPI
- `celsiusToFahrenheit()` - Convers√£o C ‚Üí F
- `celsiusToKelvin()` - Convers√£o C ‚Üí K

**main_test.go** - Testes:
- Valida√ß√£o de formato de CEP
- Convers√µes de temperatura
- Testes de endpoints HTTP
- Casos de sucesso e erro

## üîç Troubleshooting

### Porta 8080 j√° em uso

```bash
# Mudar porta no .env
echo "PORT=8081" > .env

# Reiniciar
docker-compose down && docker-compose up -d
```

### Erro de API Key

```bash
# Verificar se a vari√°vel est√° configurada
docker-compose exec weather-service env | grep WEATHER

# Verificar se a chave √© v√°lida
curl "http://api.weatherapi.com/v1/current.json?key=SUA_CHAVE&q=London"
```

### Build Docker falha

```bash
# Limpar cache e rebuildar
docker-compose down
docker system prune -f
docker-compose build --no-cache
docker-compose up -d
```

### CEP retorna temperatura zerada

Verifique:
1. API Key configurada corretamente
2. Cota da WeatherAPI n√£o esgotada (plano free: 1M req/m√™s)
3. Logs do servi√ßo: `docker-compose logs`

### Erro 500 Internal Server Error

```bash
# Ver logs detalhados
docker-compose logs -f

# Verificar conectividade com APIs externas
curl https://viacep.com.br/ws/01310100/json/
curl "http://api.weatherapi.com/v1/current.json?key=SUA_CHAVE&q=SaoPaulo"
```

## üí∞ Custos - Google Cloud Run

### Free Tier (por m√™s):
- 2 milh√µes de requisi√ß√µes
- 360,000 GB-seconds de mem√≥ria
- 180,000 vCPU-seconds

### Estimativa:
- **10,000 req/m√™s**: Gr√°tis
- **100,000 req/m√™s**: ~$0.04
- **1,000,000 req/m√™s**: ~$0.40

Com `min-instances=0`, o servi√ßo escala para zero quando n√£o h√° tr√°fego = **custo zero**.

## üîê Seguran√ßa

- ‚úÖ Valida√ß√£o rigorosa de input (CEP)
- ‚úÖ N√£o exp√µe API keys nos logs
- ‚úÖ Suporte a HTTPS autom√°tico no Cloud Run
- ‚úÖ Rate limiting configur√°vel
- ‚úÖ Health checks para monitoramento

**Recomenda√ß√µes:**
- Use Secrets Manager em produ√ß√£o
- Implemente rate limiting
- Configure CORS se necess√°rio
- Monitore logs e m√©tricas

## üìä Performance

**M√©tricas esperadas:**
- Lat√™ncia m√©dia: 200-500ms (inclui chamadas externas)
- Throughput: 100+ req/s
- Taxa de erro: < 1%
- Cold start: ~2s (Cloud Run)

## ü§ù Contribuindo

1. Fork o projeto
2. Crie uma branch (`git checkout -b feature/NovaFuncionalidade`)
3. Commit suas mudan√ßas (`git commit -m 'Adiciona nova funcionalidade'`)
4. Push para a branch (`git push origin feature/NovaFuncionalidade`)
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto foi desenvolvido para fins educacionais como parte de um desafio t√©cnico.

## üÜò Suporte

- **Documenta√ß√£o Cloud Run**: [https://cloud.google.com/run/docs](https://cloud.google.com/run/docs)
- **WeatherAPI Docs**: [https://www.weatherapi.com/docs/](https://www.weatherapi.com/docs/)
- **ViaCEP**: [https://viacep.com.br/](https://viacep.com.br/)
